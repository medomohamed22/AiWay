<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± - AIWay</title>
    <style>
        :root {
            --bg: #09090b;
            --card-bg: #18181b;
            --accent: #fbbf24; /* Gold */
            --purple: #611f69;
            --text: #ffffff;
            --text-sub: #a1a1aa;
            --border: #27272a;
            --success: #10b981;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

        /* Login Screen */
        #loginOverlay {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: var(--card-bg); padding: 40px; border-radius: 20px;
            border: 1px solid var(--border); width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 0 50px rgba(97, 31, 105, 0.2);
        }
        .login-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: var(--accent); }
        .inp {
            width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px;
            border: 1px solid var(--border); background: #000; color: white; outline: none; text-align: center;
        }
        .btn-login {
            width: 100%; padding: 12px; background: var(--purple); color: var(--accent);
            font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s;
        }
        .btn-login:hover { background: #4a1550; }

        /* Dashboard Container */
        .dashboard { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; gap: 15px; }
        .brand { font-size: 24px; font-weight: 900; background: linear-gradient(135deg, var(--purple), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logout-btn { background: #333; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent); }
        .card-title { color: var(--text-sub); font-size: 13px; margin-bottom: 8px; }
        .card-value { font-size: 24px; font-weight: bold; }
        .card-sub { font-size: 11px; color: var(--success); margin-top: 5px; }

        /* Table Styling (Fixed Scrolling) */
        .table-card { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        .table-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .search-inp { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: #000; color: white; width: 100%; max-width: 250px; text-align: right; }
        
        /* The Wrapper that makes it scrollable */
        .table-responsive {
            width: 100%;
            overflow-x: auto; /* Enable horizontal scroll */
            -webkit-overflow-scrolling: touch; /* Smooth scroll on mobile */
        }

        table { width: 100%; border-collapse: collapse; min-width: 800px; /* Force minimum width to ensure columns don't squash */ }
        
        th, td { 
            padding: 15px; 
            text-align: right; 
            border-bottom: 1px solid var(--border); 
            font-size: 14px; 
            white-space: nowrap; /* Prevent text wrapping */
        }
        
        th { color: var(--text-sub); font-weight: 600; background: rgba(0,0,0,0.2); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .user-badge { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 32px; height: 32px; background: var(--purple); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--accent); font-size: 12px; flex-shrink: 0; }

        .refresh-btn {
            background: var(--accent); color: #000; border: none; padding: 8px 15px; 
            border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px;
        }
        .loading { opacity: 0.7; pointer-events: none; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <div class="login-title">ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</div>
            <input type="password" id="adminPass" class="inp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø±ÙŠØ©">
            <button class="btn-login" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
            <div id="loginMsg" style="color: red; margin-top: 10px; font-size: 12px;"></div>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="header">
            <div class="brand">AIWay Dashboard</div>
            <div style="display:flex; gap:10px;">
                <button class="refresh-btn" onclick="fetchData(this)">ØªØ­Ø¯ÙŠØ« â†»</button>
                <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="card">
                <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ (USD)</div>
                <div class="card-value" id="totalUSD">$0.00</div>
                <div class="card-sub">ÙƒÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±</div>
            </div>
            <div class="card" style="--accent: #611f69;">
                <div class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ (Pi)</div>
                <div class="card-value" id="totalPi">0.00 Ï€</div>
                <div class="card-sub">ÙƒÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø¨Ø§Ù„Ø¨Ø§ÙŠ</div>
            </div>
            <div class="card" style="--accent: #10b981;">
                <div class="card-title">ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (100% Markup)</div>
                <div class="card-value" id="totalProfit" style="color: #10b981;">$0.00</div>
                <div class="card-sub">50% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±</div>
            </div>
            <div class="card" style="--accent: #3b82f6;">
                <div class="card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                <div class="card-value" id="totalUsers">0</div>
                <div class="card-sub">Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header">
                <span style="font-weight:700; color:white;">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙØµÙ„</span>
                <input type="text" class="search-inp" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." onkeyup="filterTable(this.value)">
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                            <th>Ø£Ù†ÙÙ‚ (USD)</th>
                            <th>Ø£Ù†ÙÙ‚ (Pi)</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // ØªØ®Ø²ÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
    let sessionPass = localStorage.getItem('admin_pass') || '';

    // --- Login Logic ---
    async function login() {
        const password = document.getElementById('adminPass').value;
        const msg = document.getElementById('loginMsg');
        
        if(!password) { msg.textContent = "Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"; return; }

        msg.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const success = await fetchData(null, password);
        
        if (success) {
            localStorage.setItem('admin_pass', password);
            sessionPass = password;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        } else {
            msg.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
        }
    }

    async function logout() {
        localStorage.removeItem('admin_pass');
        window.location.reload();
    }

    // --- Fetch Data from Backend API ---
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØªØµÙ„ Ø¨Ù…Ù„Ù Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ get-admin-stats.js Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£Ù†Ø§Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹
    async function fetchData(btn = null, passOverride = null) {
        if(btn) btn.classList.add('loading');
        
        const passToSend = passOverride || sessionPass;

        try {
            const res = await fetch('/.netlify/functions/get-admin-stats', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: passToSend })
            });

            if (res.status === 401) return false; // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£
            if (!res.ok) throw new Error("Server Error");

            const data = await res.json();
            renderDashboard(data);
            return true;

        } catch (err) {
            console.error(err);
            if(!passOverride) alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
            return false;
        } finally {
            if(btn) btn.classList.remove('loading');
        }
    }

    // --- Render Logic ---
    function renderDashboard(data) {
        const { users, stats } = data;
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
        document.getElementById('totalUSD').textContent = `$${stats.totalUSD.toFixed(2)}`;
        document.getElementById('totalPi').textContent = `${stats.totalPi.toFixed(4)} Ï€`;
        document.getElementById('totalProfit').textContent = `$${(stats.totalUSD / 2).toFixed(2)}`;
        document.getElementById('totalUsers').textContent = stats.totalUsers;

        // Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        users.forEach(user => {
            // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 0 ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª null
            const usdSpent = user.total_usd_spent || 0;
            const piSpent = user.total_pi_spent || 0;
            const balance = user.token_balance || 0;
            const joinDate = user.created_at ? new Date(user.created_at).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="user-badge">
                        <div class="avatar">${user.username ? user.username.substring(0,2).toUpperCase() : '??'}</div>
                        <div>${user.username || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
                    </div>
                </td>
                <td style="color: var(--accent); font-weight:bold;">${balance} Token</td>
                <td style="color: #a1a1aa;">$${usdSpent.toFixed(2)}</td>
                <td style="color: var(--purple); font-weight:600;">${piSpent.toFixed(4)} Ï€</td>
                <td style="direction:ltr; text-align:right; color: #777;">${joinDate}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Search Function ---
    function filterTable(query) {
        const rows = document.querySelectorAll('#usersTableBody tr');
        rows.forEach(row => {
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
            const text = row.cells[0].innerText.toLowerCase();
            row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
        });
    }

    // Check Session on Load
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø¯Ø®Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
    window.onload = () => {
        if (sessionPass) {
            fetchData(null, sessionPass).then(success => {
                if(success) {
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                }
            });
        }
    };
</script>

</body>
</html>
