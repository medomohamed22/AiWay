<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content"/>
    <title>AIWay</title>

    <!-- Libraries (deferred for better performance) -->
    <script defer src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <style>
        :root {
            --bg: #050505;
            --chat-bg: #000000;
            --card: #121212;
            --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #f59e0b 100%);
            --text-gradient: linear-gradient(135deg, #a78bfa 0%, #fbbf24 100%);
            --pi-purple: #7c3aed;
            --pi-gold: #f59e0b;
            --text-main: #ffffff;
            --text-sub: #a1a1aa;
            --border: #27272a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--chat-bg); color: var(--text-main);
            display: flex; flex-direction: column; height: 100dvh; overflow: hidden;
            direction: rtl;
        }

        /* Landing Page */
        .landing-overlay {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #1a0b2e 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center; z-index: 9999; transition: opacity 0.5s;
        }
        .landing-lang-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: 700; backdrop-filter: blur(10px); }
        .landing-logo-text { font-size: 64px; font-weight: 900; background: var(--text-gradient); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 25px rgba(124,58,237,0.4)); letter-spacing: -2px; margin-bottom: 10px; }
        .landing-desc { color: #ccc; font-size: 15px; line-height: 1.6; max-width: 320px; margin-bottom: 40px; }
        .features-title { font-size: 14px; color: var(--pi-gold); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
        .features-container { display: flex; gap: 15px; justify-content: center; margin-bottom: 50px; }
        .feature-btn { padding: 12px 24px; border-radius: 12px; font-weight: 700; font-size: 14px; min-width: 110px; cursor: default; position: relative; }
        .f-images { background: var(--primary-gradient); color: white; box-shadow: 0 0 20px rgba(245,158,11,0.3); }
        .f-video { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .soon-badge { font-size: 9px; background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; position: absolute; bottom: -10px; border: 1px solid #444; }
        .pi-login-btn { background: var(--primary-gradient); color: white; border: none; padding: 14px 50px; border-radius: 30px;
            font-weight: 800; font-size: 16px; cursor: pointer; box-shadow: 0 0 30px rgba(124,58,237,0.4); display: flex; align-items: center; gap: 10px; transition: transform 0.2s; }
        .pi-login-btn:active { transform: scale(0.95); }
        .pi-login-btn svg { width: 24px; height: 24px; fill: white; }

        /* Header */
        .header { padding: 10px 16px; background: rgba(5,5,5,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border);
            height: 60px; display: flex; align-items: center; justify-content: space-between; z-index: 100; flex-shrink: 0; }
        .header-title-area { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px 8px; border-radius: 12px; transition: 0.2s; }
        .header-title-area:active { background: rgba(255,255,255,0.05); }
        .header-cost-badge { background: var(--pi-gold); color: #000; font-size: 11px; font-weight: 800; width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin-right: 5px; }
        .header-left { display: flex; gap: 8px; align-items: center; }
        .token-btn, .lang-btn { height: 34px; border-radius: 18px; padding: 0 12px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .token-btn { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); color: var(--pi-gold); }
        .token-btn:active { transform: scale(0.95); }
        .lang-btn { background: var(--card); border: 1px solid var(--border); color: var(--text-main); }

        /* Chat Container */
        .chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 90%; animation: slideUp 0.3s ease; }
        .message.user { align-self: flex-end; }
        .message.bot { align-self: flex-start; }
        .msg-bubble { padding: 20px 24px; border-radius: 24px; font-size: 15px; line-height: 1.85; word-wrap: break-word; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .message.user .msg-bubble { background: linear-gradient(135deg, #4c1d95 0%, #2e1065 100%); color: #fff; border: 1px solid rgba(124,58,237,0.3); border-bottom-left-radius: 4px; }
        .message.bot .msg-bubble { background: transparent; padding: 0; border: 1px solid var(--border); border-radius: 20px; overflow: hidden; max-width: 340px; }

        /* Code Blocks */
        .code-wrapper { background: #111; border: 1px solid #333; border-radius: 8px; margin: 15px 0; overflow: hidden; direction: ltr; text-align: left; }
        .code-header { background: #222; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .code-lang { font-size: 12px; color: #9cdcfe; font-weight: bold; text-transform: uppercase; }
        .copy-code-btn { background: transparent; border: none; color: #ccc; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .copy-code-btn:hover { color: white; }

        /* Markdown Styling */
        .markdown-body { font-size: 14.5px; line-height: 1.75; }
        .markdown-body p { margin-bottom: 14px; }
        .markdown-body p:last-child { margin-bottom: 0; }
        .markdown-body ul, .markdown-body ol { padding-inline-start: 20px; margin-bottom: 14px; }
        .markdown-body li { margin-bottom: 6px; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: var(--pi-gold); font-weight: 700; margin: 20px 0 10px; font-size: 1.15em; }
        .markdown-body :not(pre)>code { background: rgba(255,255,255,0.1); color: #ff79c6; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }

        /* Images & Loading */
        .image-container { position: relative; width: 100%; background: #000; }
        .msg-image { width: 100%; height: auto; opacity: 0; transition: opacity 0.8s ease; display: block; loading: lazy; }
        .msg-image.loaded { opacity: 1; }
        .download-bar { padding: 12px; background: #141414; display: flex; justify-content: center; border-top: 1px solid #222; }
        .d-btn { background: var(--pi-gold); color: black; border: none; padding: 10px 0; border-radius: 10px; font-weight: 700; font-size: 13px; cursor: pointer; width: 100%; transition: 0.2s; }
        .image-loading-box { width: 100%; aspect-ratio: 1/1; border-radius: 20px; background: #111; border: 1px solid var(--border); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .blur-wave { position: absolute; inset: -50%; background: conic-gradient(from 0deg, transparent 0deg, var(--pi-purple) 100deg, transparent 180deg, var(--pi-gold) 260deg, transparent 360deg);
            filter: blur(40px); opacity: 0.5; animation: rotateWave 4s linear infinite; }
        .loading-text { position: relative; z-index: 2; font-weight: 700; font-size: 13px; color: white; background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 30px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); animation: pulse 1.5s ease-in-out infinite; }

        /* Footer & Input */
        .footer-container { background: #050505; border-top: 1px solid var(--border); padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 100; position: relative; }
        .control-bar { display: flex; gap: 10px; padding: 8px 12px 0 12px; }
        .footer-btn { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 6px 12px; color: var(--text-sub);
            font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; min-width: 90px; justify-content: space-between; transition: 0.2s; }
        .input-row { display: flex; gap: 8px; padding: 10px 12px; align-items: flex-end; }
        .input-box { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 14px 18px; color: white; outline: none; resize: none; max-height: 120px; font-size: 15px; }
        .send-btn { width: 48px; height: 48px; border-radius: 50%; background: var(--primary-gradient); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .send-btn:disabled { background: #333; cursor: not-allowed; }
        .countdown-text { color: white; font-size: 10px; text-align: center; line-height: 1; }

        /* Menus */
        .model-menu, .aspect-menu-dropdown {
            background: rgba(18,18,18,0.98); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 16px;
            display: none; flex-direction: column; gap: 5px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .model-menu { position: absolute; top: 60px; left: 0; right: 0; z-index: 90; padding: 10px; }
        .aspect-menu-dropdown { position: absolute; bottom: 100%; right: 12px; width: 200px; margin-bottom: 8px; padding: 8px; z-index: 200; }
        .menu-option { padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .menu-option.active { border-color: var(--pi-purple); background: rgba(124,58,237,0.1); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 500; }
        .modal-window { width: 90%; max-width: 400px; max-height: 80vh; background: #111; border: 1px solid var(--border); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #18181b; }
        .buy-grid { padding: 20px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        .buy-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 15px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .buy-card:active { border-color: var(--pi-gold); background: rgba(245,158,11,0.1); }

        /* Gallery */
        .gallery-grid { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 50px; display: grid; grid-template-columns: repeat(2,1fr); gap: 15px; align-content: start; }
        .gallery-item { position: relative; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); aspect-ratio: 1/1; background: #18181b; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; loading: lazy; }
        .gallery-actions { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.4) 100%); display: flex; gap: 8px; backdrop-filter: blur(2px); }
        .g-btn { flex: 1; border: none; padding: 8px 0; font-size: 11px; cursor: pointer; color: white; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .g-del { background: rgba(239,68,68,0.6); border: 1px solid rgba(239,68,68,0.3); }
        .g-down { background: var(--pi-gold); color: black; border: 1px solid var(--pi-gold); }

        /* No Tokens Card */
        .no-token-card { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 20px; padding: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .no-token-text { color: #fca5a5; font-size: 14px; font-weight: 600; }

        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes rotateWave { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <!-- Landing Page -->
    <div id="landingPage" class="landing-overlay">
        <button class="landing-lang-btn" id="landingLangBtn" onclick="toggleLanguage()">AR</button>
        <div class="landing-logo-text">AiWay</div>
        <div class="landing-desc" id="txtLandingDesc">Generate professional images using state-of-the-art AI technologies</div>
        <div class="features-title" id="txtFeaturesTitle">Site Supports</div>
        <div class="features-container">
            <button class="feature-btn f-images"><span>Ai Images</span></button>
            <button class="feature-btn f-video"><span>Ai Video</span><span class="soon-badge" id="txtSoonVideo">Soon</span></button>
            <button class="feature-btn f-images"><span>Ai Chat</span></button>
        </div>
        <button class="pi-login-btn" onclick="authenticatePi()">
            <svg viewBox="0 0 32 32"><path d="M16 32C7.163 32 0 24.837 0 16S7.163 0 16 0s16 7.163 16 16-7.163 16-16 16zm-2.5-22h-3v12h3V10zm8 0h-3v12h3V10z"/></svg>
            <span id="txtLogin">Pi Login</span>
        </button>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-title-area" onclick="toggleModelMenu()">
            <div id="headerModelName" style="font-weight:700; font-size:16px; display:flex; align-items:center;">Imagen 4</div>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="#777" id="modelChevron" style="transition:0.3s; margin-inline-start:5px;"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        </div>
        <div class="header-left">
            <button class="lang-btn" id="langBtn" onclick="toggleLanguage()">AR</button>
            <button class="token-btn" onclick="openBuyModal()">
                <svg class="token-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05 1.18 1.91 2.53 1.91 1.38 0 2.53-.83 2.53-1.94 0-.85-.38-1.55-2.03-1.95l-1.04-.25c-2.31-.55-3.62-1.89-3.62-3.63 0-1.86 1.34-3.2 3.14-3.56V4h2.67v1.9c1.68.39 2.92 1.43 3.08 3.13h-2.01c-.13-.88-.95-1.57-2.19-1.57-1.32 0-2.19.85-2.19 1.83 0 .74.43 1.35 2.17 1.77l.82.2c2.51.6 3.84 1.95 3.84 3.73 0 1.96-1.5 3.33-3.22 3.66z"/></svg>
                <span id="tokenBalance">0</span> Ï€
            </button>
        </div>
    </div>

    <div class="model-menu" id="modelMenu"></div>

    <div class="chat-container" id="chatContainer">
        <div style="text-align:center; color:#555; margin-top:50px;" id="emptyMsg">
            Welcome to AIWay <br> Select a model and imagine
        </div>
    </div>

    <!-- Footer -->
    <div class="footer-container">
        <div class="control-bar">
            <button class="footer-btn" onclick="openGallery()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4z"/></svg>
                <span id="txtGallery">Gallery</span>
            </button>
            <div class="aspect-menu-dropdown" id="aspectMenu"></div>
            <button class="footer-btn" id="aspectTriggerBtn" onclick="toggleAspectMenu(event)">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="currentAspectIcon"></span>
                    <span id="currentAspectLabel">1:1</span>
                </div>
                <svg width="10" height="10" viewBox="0 0 24 24" fill="#777"><path d="M7 10l5 5 5-5z"/></svg>
            </button>
        </div>
        <div class="input-row">
            <textarea id="promptInput" class="input-box" rows="1" placeholder="Imagine anything..." dir="auto"></textarea>
            <button class="send-btn" id="sendBtn">
                <svg id="sendIcon" width="22" height="22" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                <span id="countdownEl" class="countdown-text" style="display:none;"></span>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="galleryModal" class="modal-overlay">
        <div class="modal-window" style="height:80%;">
            <div class="modal-header">
                <span style="font-weight:700; color:white;" id="txtGalleryTitle">My Gallery</span>
                <button onclick="document.getElementById('galleryModal').style.display='none'" style="background:none; border:none; color:white; font-size:24px;">âœ•</button>
            </div>
            <div class="gallery-grid" id="galleryGrid"></div>
        </div>
    </div>

    <div id="buyModal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
                <span style="font-weight:700; color:white;" id="txtBuyTitle">Buy Tokens</span>
                <button onclick="document.getElementById('buyModal').style.display='none'" style="background:none; border:none; color:white; font-size:24px;">âœ•</button>
            </div>
            <div class="buy-grid" id="buyGrid"></div>
        </div>
    </div>

    <div id="downloadInfoModal" class="modal-overlay">
        <div class="modal-window" style="padding:20px; align-items:center;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ“‹</div>
            <div class="dl-help-title" id="txtDlTitle">Link Copied!</div>
            <div class="dl-help-text" id="txtDlDesc">Due to Pi Browser limitations, please paste this link into Google Chrome to download the image immediately.</div>
            <div class="dl-copy-box" id="dlLinkBox">...</div>
            <button class="g-btn g-down" onclick="document.getElementById('downloadInfoModal').style.display='none'" style="width:100%; max-width:200px; padding:12px;">OK</button>
        </div>
    </div>

    <script defer>
        /* ====================== CONFIG & STATE ====================== */
        const MODELS = [
            { id: 'openai-large', category: 'Chat & Vision', name: 'GPT-5.2', type: 'text', cost: 3, desc: 'Deep Reasoning' },
            { id: 'openai-fast', category: 'Chat & Vision', name: 'GPT-5 Nano', type: 'text', cost: 1, desc: 'Fast Chat' },
            { id: 'openai', category: 'Chat & Vision', name: 'GPT-5 Mini', type: 'text', cost: 1, desc: 'Balanced' },
            { id: 'imagen-4', category: 'Image Generation', name: 'Imagen 4', type: 'image', cost: 1, desc: 'High Quality' },
            { id: 'gptimage', category: 'Image Generation', name: 'Chat GPT Image', type: 'image', cost: 5, desc: 'Creative' },
            { id: 'klein', category: 'Image Generation', name: 'FLUX.2 Klein 4B', type: 'image', cost: 2, desc: 'Fast Gen' },
            { id: 'klein-large', category: 'Image Generation', name: 'FLUX.2 Klein 9B', type: 'image', cost: 4, desc: 'Detailed' }
        ];

        const RATIOS = [
            { id: 'square', label: '1:1', w: 1024, h: 1024, icon: '<rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>' },
            { id: 'portrait', label: '9:16', w: 768, h: 1344, icon: '<rect x="6" y="3" width="12" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>' },
            { id: 'landscape', label: '16:9', w: 1344, h: 768, icon: '<rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>' },
            { id: 'wide', label: '21:9', w: 1536, h: 640, icon: '<rect x="2" y="8" width="20" height="8" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>' }
        ];

        const PACKAGES = [
            { usd: 1, tokens: 150 },
            { usd: 5, tokens: 750 },
            { usd: 10, tokens: 1500 }
        ];

        const TRANSLATIONS = {
            ar: {
                gallery: "Ù…Ø¹Ø±Ø¶ÙŠ", welcome: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ AIWay <br> Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ÙˆØ§ÙƒØªØ¨ Ù…Ø§ ØªØªØ®ÙŠÙ„Ù‡",
                placeholder: "ØªØ®ÙŠÙ„ Ø£ÙŠ Ø´ÙŠØ¡...", generating: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...", download: "ØªØ­Ù…ÙŠÙ„",
                delete: "Ø­Ø°Ù", error: "Ø®Ø·Ø£", galleryTitle: "Ù…Ø¹Ø±Ø¶ ØµÙˆØ±ÙŠ", buyTitle: "Ø´Ø±Ø§Ø¡ ØªÙˆÙƒÙŠÙ†",
                noImages: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø­ÙÙˆØ¸Ø©.", confirmDel: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ", wait: "Ø§Ù†ØªØ¸Ø±",
                sec: "Ø«", noImage: "Ù…ÙÙŠØ´ ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„", buy: "Ø´Ø±Ø§Ø¡", tokens: "ØªÙˆÙƒÙŠÙ†", pi: "Ï€",
                noTokens: "Ø±ØµÙŠØ¯ Ø§Ù„ØªÙˆÙƒÙŠÙ† Ù†ÙØ° ğŸ˜¢", buyNow: "Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†", cost: "ØªÙˆÙƒÙŠÙ†", done: "ØªÙ…",
                desc: "ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ± Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø­Ø¯Ø« ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", login: "Pi Login",
                features: "Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯Ø¹Ù…", soon: "Ù‚Ø±ÙŠØ¨Ø§Ù‹", usd: "Ø¯ÙˆÙ„Ø§Ø±",
                dlTitle: "ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©! ğŸ“‹",
                dlDesc: "Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ù…ØªØµÙØ­ Pi Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù…ØªØµÙØ­ Google Chrome Ù„ÙŠØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙÙˆØ±Ø§Ù‹.\nÙ‡Ø°Ø§ Ø­Ù„ Ù…Ø¤Ù‚Øª Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØµÙØ­.",
                rateLimit: "Ø¶ØºØ· Ø¹Ø§Ù„ÙŠ! Ø§Ù†ØªØ¸Ø± 25 Ø«Ø§Ù†ÙŠØ©..."
            },
            en: {
                gallery: "Gallery", welcome: "Welcome to AIWay <br> Select a model and imagine.",
                placeholder: "Imagine anything...", generating: "Generating...", download: "Download",
                delete: "Delete", error: "Error", galleryTitle: "My Gallery", buyTitle: "Buy Tokens",
                noImages: "No saved images.", confirmDel: "Are you sure?", wait: "Wait",
                sec: "s", noImage: "No image to download", buy: "Buy", tokens: "Tokens", pi: "Ï€",
                noTokens: "Out of Tokens ğŸ˜¢", buyNow: "Buy Now", cost: "Tokens", done: "Done",
                desc: "Generate professional images using state-of-the-art AI technologies", login: "Pi Login",
                features: "Site Supports", soon: "Soon", usd: "USD",
                dlTitle: "Link Copied! ğŸ“‹",
                dlDesc: "Due to Pi Browser limitations, please paste this link into Google Chrome to download the image immediately.\nThis is a temporary solution.",
                rateLimit: "High traffic! Wait 25s..."
            }
        };

        let currentLang = 'en', currentModel = 'imagen-4', currentWidth = 1024, currentHeight = 1024, currentRatioId = 'square';
        let piUser = null, chatHistory = [], cooldownEndTime = 0, currentPiPrice = 40.0;
        let abortController = null;

        /* ====================== UTILS ====================== */
        function safeRemove(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function scrollToBottom() { const c = document.getElementById('chatContainer'); c.scrollTop = c.scrollHeight; }

        function copyCode(btn) {
            const wrapper = btn.closest('.code-wrapper');
            if (!wrapper) return;
            const code = wrapper.querySelector('code');
            if (!code) return;
            const text = code.innerText || code.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const orig = btn.innerHTML;
                btn.innerHTML = 'âœ… Copied!';
                setTimeout(() => btn.innerHTML = orig, 2000);
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
            });
        }

        function normalizeMessages(list) {
            return (Array.isArray(list) ? list : []).filter(m => m && (m.role === "user" || m.role === "assistant") && typeof m.content === "string").slice(-24);
        }

        /* ====================== MARKDOWN + SANITIZE ====================== */
        const renderer = new marked.Renderer();
        renderer.code = (code, lang) => {
            const validLang = lang || 'plaintext';
            const escaped = String(code).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return `<div class="code-wrapper">
                <div class="code-header">
                    <span class="code-lang">${validLang.toUpperCase()}</span>
                    <button class="copy-code-btn" onclick="copyCode(this)">ğŸ“‹ Copy</button>
                </div>
                <pre><code class="language-${validLang}">${escaped}</code></pre>
            </div>`;
        };
        marked.setOptions({ renderer, gfm: true, breaks: true });

        function renderMarkdownSafe(text) {
            const dirty = marked.parse(text || "");
            return DOMPurify.sanitize(dirty);
        }

        /* ====================== UI FUNCTIONS ====================== */
        function updateHeaderModelUI() {
            const m = MODELS.find(x => x.id === currentModel) || MODELS[0];
            currentModel = m.id;
            document.getElementById('headerModelName').innerHTML = `${m.name} <span class="header-cost-badge">${m.cost}</span>`;
            const aspectBtn = document.getElementById('aspectTriggerBtn');
            const input = document.getElementById('promptInput');
            const t = TRANSLATIONS[currentLang];
            if (m.type === 'text') {
                aspectBtn.style.display = 'none';
                input.placeholder = currentLang === 'ar' ? "Ø§Ø³Ø£Ù„ Ø£ÙŠ Ø´ÙŠØ¡..." : "Ask me anything...";
            } else {
                aspectBtn.style.display = 'flex';
                input.placeholder = t.placeholder;
            }
        }

        function renderModelMenu() {
            const menu = document.getElementById('modelMenu');
            menu.innerHTML = '';
            const categories = [...new Set(MODELS.map(m => m.category))];
            categories.forEach(cat => {
                const title = document.createElement('div');
                title.className = 'menu-category-title';
                title.textContent = cat;
                menu.appendChild(title);
                MODELS.filter(m => m.category === cat).forEach(m => {
                    const div = document.createElement('div');
                    div.className = `menu-option ${m.id === currentModel ? 'active' : ''}`;
                    div.onclick = () => { currentModel = m.id; updateHeaderModelUI(); toggleModelMenu(); renderModelMenu(); };
                    const tag = m.type === 'image' ? '<span class="model-tag tag-img">IMG</span>' : '<span class="model-tag tag-txt">CHAT</span>';
                    div.innerHTML = `<div><div style="font-weight:700; font-size:14px; color:white;">${m.name}</div><div style="font-size:11px; color:#888; margin-top:3px;">${tag} ${m.desc}</div></div><div style="font-size:11px; font-weight:bold; color:var(--pi-gold); background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:6px;">${m.cost}</div>`;
                    menu.appendChild(div);
                });
            });
        }

        function toggleModelMenu() {
            const menu = document.getElementById('modelMenu');
            const chevron = document.getElementById('modelChevron');
            const visible = menu.style.display === 'flex';
            menu.style.display = visible ? 'none' : 'flex';
            chevron.style.transform = visible ? 'rotate(0deg)' : 'rotate(180deg)';
            if (!visible) document.getElementById('aspectMenu').style.display = 'none';
        }

        function renderAspectMenu() {
            const menu = document.getElementById('aspectMenu');
            menu.innerHTML = '';
            RATIOS.forEach(r => {
                const div = document.createElement('div');
                div.className = `menu-option ${r.id === currentRatioId ? 'active' : ''}`;
                div.onclick = () => { currentWidth = r.w; currentHeight = r.h; currentRatioId = r.id; updateAspectUI(); menu.style.display = 'none'; renderAspectMenu(); };
                div.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:white;">${r.icon}</svg><span style="font-size:13px; font-weight:600; color:white;">${r.label}</span></div>`;
                menu.appendChild(div);
            });
        }

        function updateAspectUI() {
            const r = RATIOS.find(x => x.id === currentRatioId) || RATIOS[0];
            document.getElementById('currentAspectLabel').textContent = r.label;
            document.getElementById('currentAspectIcon').innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none">${r.icon}</svg>`;
        }

        function toggleAspectMenu(e) {
            if (e) e.stopPropagation();
            const menu = document.getElementById('aspectMenu');
            const visible = menu.style.display === 'flex';
            menu.style.display = visible ? 'none' : 'flex';
            if (!visible) document.getElementById('modelMenu').style.display = 'none';
        }

        function renderBuyGrid() {
            const grid = document.getElementById('buyGrid');
            grid.innerHTML = '';
            const t = TRANSLATIONS[currentLang];
            PACKAGES.forEach(pkg => {
                const piAmount = (pkg.usd / currentPiPrice).toFixed(4);
                const div = document.createElement('div');
                div.className = 'buy-card';
                div.onclick = () => buyTokens(pkg, piAmount);
                div.innerHTML = `
                    <div class="buy-info">
                        <span class="buy-amount">${pkg.tokens} ${t.tokens}</span>
                        <span class="buy-cost" style="color:#aaa; font-size:11px;">$${pkg.usd}</span>
                        <span class="buy-cost">${piAmount} ${t.pi}</span>
                    </div>
                    <svg class="buy-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                `;
                grid.appendChild(div);
            });
        }

        function openBuyModal() { renderBuyGrid(); document.getElementById('buyModal').style.display = 'flex'; }

        /* ====================== AUTH & PAYMENTS ====================== */
        authenticatePi



        function onIncompletePayment(payment) { console.log("Incomplete Payment", payment); }

        async function fetchBalance() {
            if (!piUser) return;
            try {
                const res = await fetch(`/api/get-balance?uid=${piUser.uid}`);
                const data = await res.json();
                document.getElementById('tokenBalance').textContent = data.balance || 0;
            } catch (e) { console.error("Balance Error", e); }
        }

        async function fetchPiPrice() {
            try {
                const res = await fetch('/api/get-pi-price');
                const data = await res.json();
                if (data.price) {
                    currentPiPrice = data.price;
                    if (document.getElementById('buyModal').style.display === 'flex') renderBuyGrid();
                }
            } catch (e) { console.log("Using default price"); }
        }

        async function buyTokens(pkg, piAmount) {
            if (!piUser) return alert("Login first");
            try {
                const paymentData = { amount: parseFloat(piAmount), memo: `${pkg.tokens} Tokens - AIWay`, metadata: { type: "tokens", tokenAmount: pkg.tokens, pi_uid: piUser.uid } };
                await Pi.createPayment(paymentData, {
                    onReadyForServerApproval: async (paymentId) => {
                        const res = await fetch('/api/approve', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ paymentId }) });
                        if (!res.ok) throw new Error("Approval Failed");
                    },
                    onReadyForServerCompletion: async (paymentId, txid) => {
                        const res = await fetch('/api/complete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ paymentId, txid, pi_uid: piUser.uid, username: piUser.username, tokenAmount: pkg.tokens, usdAmount: pkg.usd, pAmount: paymentData.amount })
                        });
                        if (!res.ok) throw new Error("Completion Failed");
                        const data = await res.json();
                        document.getElementById('tokenBalance').textContent = data.newBalance;
                        document.getElementById('buyModal').style.display = 'none';
                        alert(`+${pkg.tokens} Tokens!`);
                    },
                    onCancel: () => console.log("Cancelled"),
                    onError: (error) => console.error("Error", error)
                });
            } catch (e) { console.error(e); alert("Payment Failed"); }
        }

        /* ====================== CHAT & GENERATION ====================== */
        async function sendPrompt() {
            if (Date.now() < cooldownEndTime || !piUser) return;
            if (abortController) abortController.abort();
            abortController = new AbortController();

            const input = document.getElementById('promptInput');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';

            addMessage(text, 'user');
            const m = MODELS.find(x => x.id === currentModel) || MODELS[0];
            const isChat = m.type === 'text';
            const loadingId = renderLoader(isChat);
            triggerCooldown(5);

            try {
                const payload = { prompt: text, username: piUser.username, pi_uid: piUser.uid, model: currentModel };
                if (isChat) payload.messages = [...normalizeMessages(chatHistory), { role: "user", content: text }];
                else { payload.width = currentWidth; payload.height = currentHeight; }

                const res = await fetch('/api/generate-and-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: abortController.signal
                });

                const data = await res.json();
                safeRemove(loadingId);

                if (!res.ok) {
                    if (res.status === 403 && data?.error === 'INSUFFICIENT_TOKENS') addNoTokenCard();
                    else if (res.status === 429) { addBotText(TRANSLATIONS[currentLang].rateLimit); triggerCooldown(25); }
                    else addBotText(`âš ï¸ Error (${res.status}): ${data?.error || "Server error"}`);
                    return;
                }

                document.getElementById('tokenBalance').textContent = data.newBalance || document.getElementById('tokenBalance').textContent;

                if (data.reply) {
                    chatHistory.push({ role: "user", content: text }, { role: "assistant", content: data.reply });
                    addBotText(data.reply);
                } else if (data.imageUrl || data.image_url || data.url) {
                    const url = data.imageUrl || data.image_url || data.url;
                    addBotImage(url, data.width, data.height);
                } else addBotText("âš ï¸ AI returned no content");
            } catch (err) {
                if (err.name !== 'AbortError') { safeRemove(loadingId); addBotText("âš ï¸ Network / AI overload"); triggerCooldown(12); }
            }
        }

        function renderLoader(isChat) {
            const div = document.createElement('div');
            div.className = 'message bot';
            div.id = 'loading-' + Date.now();
            div.innerHTML = isChat ? `<div class="chat-loading-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>` :
                `<div class="image-loading-box"><div class="blur-wave"></div><div class="loading-text">Generating...</div></div>`;
            document.getElementById('chatContainer').appendChild(div);
            scrollToBottom();
            return div.id;
        }

        function addMessage(content, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<div class="msg-bubble">${content}</div>`;
            document.getElementById('chatContainer').appendChild(div);
            document.getElementById('emptyMsg').style.display = 'none';
            scrollToBottom();
        }

        function addBotText(text) {
            const div = document.createElement('div');
            div.className = 'message bot';
            const safeHtml = renderMarkdownSafe(text);
            div.innerHTML = `<div class="msg-bubble"><div class="markdown-body">${safeHtml}</div></div>`;
            document.getElementById('chatContainer').appendChild(div);
            scrollToBottom();
        }

        function addBotImage(url, w, h) {
            const t = TRANSLATIONS[currentLang];
            const div = document.createElement('div');
            div.className = 'message bot';
            const ratio = (w || currentWidth) / (h || currentHeight);
            div.innerHTML = `
                <div class="msg-bubble">
                    <div class="image-container" style="aspect-ratio: ${ratio};">
                        <img src="${url}" class="msg-image" onload="this.classList.add('loaded')" loading="lazy">
                    </div>
                    <div class="download-bar">
                        <button class="d-btn" onclick="forceDownload('${url}')">${t.download}</button>
                    </div>
                </div>`;
            document.getElementById('chatContainer').appendChild(div);
            scrollToBottom();
        }

        function addNoTokenCard() {
            const t = TRANSLATIONS[currentLang];
            const div = document.createElement('div');
            div.className = 'message bot';
            div.innerHTML = `<div class="msg-bubble"><div class="no-token-card"><div class="no-token-text">${t.noTokens}</div><button class="buy-now-btn" onclick="openBuyModal()">${t.buyNow}</button></div></div>`;
            document.getElementById('chatContainer').appendChild(div);
            scrollToBottom();
        }

        function triggerCooldown(seconds) {
            cooldownEndTime = Date.now() + seconds * 1000;
            updateCooldownUI();
        }

        function updateCooldownUI() {
            const now = Date.now();
            const btn = document.getElementById('sendBtn');
            const icon = document.getElementById('sendIcon');
            const countEl = document.getElementById('countdownEl');
            const t = TRANSLATIONS[currentLang];
            if (now < cooldownEndTime) {
                const remaining = Math.ceil((cooldownEndTime - now) / 1000);
                btn.disabled = true; icon.style.display = 'none'; countEl.style.display = 'block';
                countEl.innerText = `${t.wait} ${remaining}${t.sec}`;
                requestAnimationFrame(updateCooldownUI);
            } else {
                btn.disabled = false; icon.style.display = 'block'; countEl.style.display = 'none';
            }
        }

        async function forceDownload(url) {
            const downloadUrl = url + "?download=";
            try {
                await navigator.clipboard.writeText(downloadUrl);
                showInfoModal(downloadUrl);
            } catch {
                const ta = document.createElement('textarea');
                ta.value = downloadUrl; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                showInfoModal(downloadUrl);
            }
        }

        function showInfoModal(link) {
            document.getElementById('dlLinkBox').textContent = link;
            document.getElementById('downloadInfoModal').style.display = 'flex';
        }

        async function openGallery() {
            if (!piUser) return alert("Login Required");
            const modal = document.getElementById('galleryModal');
            const grid = document.getElementById('galleryGrid');
            modal.style.display = 'flex';
            grid.innerHTML = '<div style="color:white; text-align:center; grid-column: span 2;">Loading...</div>';
            try {
                const res = await fetch(`/api/get-gallery?username=${piUser.username}`);
                const images = await res.json();
                grid.innerHTML = '';
                if (!Array.isArray(images) || images.length === 0) {
                    grid.innerHTML = `<div style="color:#777; padding:20px; grid-column: span 2; text-align:center;">${TRANSLATIONS[currentLang].noImages}</div>`;
                    return;
                }
                images.forEach(img => {
                    const div = document.createElement('div');
                    div.className = 'gallery-item';
                    div.innerHTML = `
                        <img src="${img.url}" loading="lazy">
                        <div class="gallery-actions">
                            <button class="g-btn g-down" onclick="forceDownload('${img.url}')">${TRANSLATIONS[currentLang].download}</button>
                            <button class="g-btn g-del" onclick="deleteImage('${img.id}', this)">${TRANSLATIONS[currentLang].delete}</button>
                        </div>`;
                    grid.appendChild(div);
                });
            } catch (e) {
                grid.innerHTML = `<div style="color:red; grid-column: span 2;">${TRANSLATIONS[currentLang].error}</div>`;
            }
        }

        async function deleteImage(id, btn) {
            if (!confirm(TRANSLATIONS[currentLang].confirmDel)) return;
            const parent = btn.closest('.gallery-item');
            parent.style.opacity = '0.5';
            try {
                const res = await fetch('/api/delete-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, username: piUser.username }) });
                if (res.ok) parent.remove();
                else { alert(TRANSLATIONS[currentLang].error); parent.style.opacity = '1'; }
            } catch (e) { console.error(e); }
        }

        async function loadChatHistory() {
            if (!piUser) return;
            const loading = document.createElement('div');
            loading.innerHTML = '<div style="text-align:center; color:#555;">Loading history...</div>';
            document.getElementById('chatContainer').appendChild(loading);
            try {
                const res = await fetch(`/api/get-chat-history?username=${piUser.username}`);
                const list = await res.json() || [];
                document.getElementById('emptyMsg').style.display = 'none';
                loading.remove();
                list.forEach(item => {
                    if (item.prompt) { addMessage(item.prompt, 'user'); chatHistory.push({ role: "user", content: item.prompt }); }
                    if (item.type === 'text' && item.bot_response) { addBotText(item.bot_response); chatHistory.push({ role: "assistant", content: item.bot_response }); }
                    else if (item.image_url || item.imageUrl) addBotImage(item.image_url || item.imageUrl, item.width, item.height);
                });
                chatHistory = normalizeMessages(chatHistory);
                scrollToBottom();
            } catch (e) {
                console.error(e);
                loading.innerHTML = '<div style="color:red; text-align:center;">Failed to load history</div>';
            }
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            ['langBtn', 'landingLangBtn'].forEach(id => document.getElementById(id).textContent = currentLang === 'ar' ? 'EN' : 'AR');
            applyLanguage(currentLang);
            updateHeaderModelUI();
        }

        function applyLanguage(lang) {
            const t = TRANSLATIONS[lang];
            const els = {
                txtGallery: 'gallery', emptyMsg: 'welcome', promptInput: 'placeholder', txtGalleryTitle: 'galleryTitle',
                txtBuyTitle: 'buyTitle', txtLandingDesc: 'desc', txtLogin: 'login', txtFeaturesTitle: 'features',
                txtSoonVideo: 'soon', txtDlTitle: 'dlTitle'
            };
            Object.keys(els).forEach(id => {
                const el = document.getElementById(id);
                if (el) el[el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' ? 'placeholder' : id === 'emptyMsg' || id === 'txtDlDesc' ? 'innerHTML' : 'textContent'] = t[els[id]];
            });
            document.getElementById('txtDlDesc').innerHTML = t.dlDesc.replace(/\n/g, '<br>');
            renderModelMenu(); renderBuyGrid();
        }

        /* ====================== INIT ====================== */
        document.addEventListener('DOMContentLoaded', () => {
            try { Pi.init({ version: "2.0", sandbox: false }); } catch (e) { console.error(e); }
            document.getElementById('promptInput').addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); }
            });
            renderModelMenu(); renderAspectMenu(); updateAspectUI(); applyLanguage('en'); updateHeaderModelUI();
            fetchPiPrice(); setInterval(fetchPiPrice, 10000);
            document.addEventListener('click', e => {
                if (!e.target.closest('#modelMenu') && !e.target.closest('.header-title-area')) { document.getElementById('modelMenu').style.display = 'none'; document.getElementById('modelChevron').style.transform = 'rotate(0deg)'; }
                if (!e.target.closest('#aspectMenu') && !e.target.closest('#aspectTriggerBtn')) document.getElementById('aspectMenu').style.display = 'none';
            });
        });
    </script>
</body>
</html>
